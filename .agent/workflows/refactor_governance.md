---
description: Full-stack refactoring governance workflow for systematic risk reduction
---

# 全栈重构与优化工作流

> **核心目标**：降低工程风险，而非追求代码洁癖。
> **唯一评价标准**：风险是否降低了？

你的任务不是"重写代码"，而是系统性降低工程风险、隐性副作用和未来维护成本。
请以 **稳定性、可回滚性、可演进性** 为唯一目标执行。

---

## 一、总目标（不可偏离）

1. 消除隐性副作用（UI / 状态 / 数据 / 事务）
2. 明确职责边界（UI vs 业务、状态 vs 副作用）
3. 防止未来"悄悄变坏"
4. 所有改动必须 **可解释、可回滚、可拆分**

**不追求代码洁癖，不追求一次性最优。**

---

## 二、三条铁律（前后端通用，必须遵守）

1. **Bug Fix / Refactor / Optimization 不得混合**
2. **用户可感知行为变化必须被显式说明**
3. **任何改动必须支持 5 分钟内回滚**

---

## 三、执行阶段

### Phase 0 — 基线确认（不修改）

- 已存在的安全机制（如防闪烁、熔断、兜底）视为系统基线
- 不回滚、不重构、不重写

---

### Phase 1 — UI / 状态 / 副作用审计（最高优先级）

#### 1.1 UI 状态清单

扫描并列出所有 UI / 全局状态：
- theme / locale / auth / permission
- modal / drawer / sidebar
- feature flag

对每个状态明确：

| 状态 | 来源 | 使用位置 | 触发副作用 | 高频变化 |
|------|------|----------|-----------|---------|
| theme | ThemeContext | 全局 | document.classList | 否 |
| locale | I18nContext | 全局 | localStorage | 否 |
| ... | ... | ... | ... | ... |

#### 1.2 副作用集中检查

扫描所有包含以下行为的代码：

**前端**：
- `useEffect` / 生命周期中操作 `document` / `window`
- 修改 `class` / `scroll` / `event listener`

**后端**：
- 直接写 DB + 发消息 + 调外部服务

要求：
- [ ] 副作用必须集中
- [ ] 必须幂等
- [ ] 必须可审计
- [ ] 必须有清晰边界

---

### Phase 2 — 动画 / 渲染 / 状态切换边界（前端重点）

#### 动画分级（必须遵守）

| 类型 | 规则 | 示例 |
|------|------|------|
| 交互动画 ✅ | 允许 | hover / focus / press |
| 流程动画 ⚠️ | 有限使用 | modal / drawer / dropdown |
| 状态切换 ❌ | 禁止 | theme / locale / auth / route |

> 状态切换必须是瞬时、原子性的。如存在兜底机制，仅作为安全网。

---

### Phase 3 — 基础层纯化（前端）

#### 基础组件要求

基础组件（Button / Input / Modal 等）：
- 只负责样式和最小交互
- **不包含**：业务逻辑、权限、请求、toast

#### 禁止
- 基础组件感知业务状态
- className 组合爆炸（超过 5 个条件判断）

---

### Phase 4 — 数据 / 业务 / 副作用解耦（后端重点）

#### 必查点

| 问题 | 检查方法 |
|------|----------|
| 隐式业务规则 | 搜索魔法数字、默认行为 |
| 一个函数多个副作用 | 检查 DB + MQ + Cache 混合操作 |
| 接口返回结构不稳定 | 对比多个版本的 DTO |
| 事务边界模糊 | 检查 `BeginTx` 使用 |

#### 要求
- 业务规则显式化
- 副作用集中
- 接口契约稳定
- 原子性明确

---

### Phase 5 — 外部依赖与环境统一入口

扫描并标记：
- `localStorage` / `sessionStorage`
- URL query
- system theme / window size
- 配置 / feature flag

要求：
- 不允许分散读取
- 必须通过统一入口（如 `useLocalStorage`, `useUrlParam`）

---

### Phase 6 — 工程保障（持续）

#### PR 要求
- [ ] 单 PR 单责任
- [ ] 明确说明是否有用户可感知变化
- [ ] 禁止"顺手优化"
- [ ] 禁止大而不可回滚的提交

---

## 四、执行方式要求（非常重要）

- 按 Phase 顺序执行
- Phase 1–2 可并行审计，但 PR 必须拆分
- **不允许一次性"大扫除"**
- 每个 PR 都必须能独立回滚、独立解释

---

## 五、验收标准（Definition of Done）

- [ ] 无新增隐性副作用
- [ ] 状态切换行为可预测
- [ ] 动画只用于交互
- [ ] 基础层职责清晰
- [ ] 出问题可快速定位和回滚

---

## 六、最终原则（作为长期行为准则）

> 你的职责不是"让代码更漂亮"，而是：
> **确保系统在未来几年内不会悄悄失控**

---

## 结束指令

请严格按以上流程执行：
- 不擅自合并阶段
- 不扩大修改范围
- 所有改动以"风险降低"为唯一评价标准
