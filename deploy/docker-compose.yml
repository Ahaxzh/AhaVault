# ==============================================================================
# AhaVault 生产环境容器编排配置
# Production Docker Compose Configuration
# ==============================================================================
# 架构说明 | Architecture:
#   1. postgres - PostgreSQL 数据持久化
#   2. redis    - 会话缓存与限流
#   3. server   - Go 核心业务服务
#   4. web      - Nginx 静态托管 + 反向代理
#
# 安全说明 | Security:
#   - 基础设施服务 (postgres/redis) 不暴露宿主机端口
#   - Redis 强制密码认证
#   - 所有敏感配置通过 .env 文件注入
# ==============================================================================

name: ahavault

services:
  # ----------------------------------------------------------------------------
  # 1. 关系型数据库 | PostgreSQL
  # ----------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: ahavault_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ahavault}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-ahavault}
      TZ: Asia/Shanghai
    # 安全: 不暴露端口到宿主机，仅允许 Docker 内部网络访问
    # 如需外部调试，取消注释下方端口映射
    # ports:
    #   - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../server/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ahavault} -d ${POSTGRES_DB:-ahavault}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------------------
  # 2. 缓存与限流 | Redis
  # ----------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: ahavault_redis
    restart: always
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-changeme}"]
    # 安全: 不暴露端口到宿主机
    # 如需外部调试，取消注释下方端口映射
    # ports:
    #   - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------------------
  # 3. 业务核心服务 | Go Server
  # ----------------------------------------------------------------------------
  server:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-ahaxzh}/ahavault-server:latest
    container_name: ahavault_server
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # 应用配置
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # 数据库配置（容器内部）
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-ahavault}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-ahavault}
      - POSTGRES_SSL_MODE=disable
      - POSTGRES_MAX_OPEN_CONNS=${DB_MAX_OPEN_CONNS:-100}
      - POSTGRES_MAX_IDLE_CONNS=${DB_MAX_IDLE_CONNS:-10}
      - POSTGRES_CONN_MAX_LIFETIME=${DB_CONN_MAX_LIFETIME:-1h}

      # Redis 配置（容器内部）
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
      - REDIS_DB=0
      - REDIS_POOL_SIZE=10
      - REDIS_TIMEOUT=5s

      # 存储配置
      - STORAGE_TYPE=local
      - LOCAL_STORAGE_PATH=/data/storage

      # 加密配置（关键安全配置）
      - APP_MASTER_KEY=${APP_MASTER_KEY}
      - JWT_SECRET=${JWT_SECRET}

      # 服务器配置
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_READ_TIMEOUT=${SERVER_READ_TIMEOUT:-10s}
      - SERVER_WRITE_TIMEOUT=${SERVER_WRITE_TIMEOUT:-10s}
      - GIN_MODE=release

      # 业务配置
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-2147483648}
      - DEFAULT_USER_QUOTA=${DEFAULT_USER_QUOTA:-10737418240}
      - REGISTRATION_ENABLED=${REGISTRATION_ENABLED:-false}
    volumes:
      - storage_data:/data/storage
      - temp_data:/data/temp
    # 可选：暴露 API 端口用于调试
    # ports:
    #   - "8080:8080"

  # ----------------------------------------------------------------------------
  # 4. 前端 + 反向代理 | Web (Nginx)
  # ----------------------------------------------------------------------------
  web:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-ahaxzh}/ahavault-web:latest
    container_name: ahavault_web
    restart: always
    depends_on:
      - server
    ports:
      - "${WEB_PORT:-80}:80"
    # 注意: VITE_API_URL 在 Docker 镜像构建时注入
    # 运行时 Nginx 负责将 /api 请求反向代理到 server 服务

# ------------------------------------------------------------------------------
# 数据持久化卷 | Persistence Volumes
# ------------------------------------------------------------------------------
volumes:
  postgres_data:
    name: ahavault_postgres_data
  redis_data:
    name: ahavault_redis_data
  storage_data:
    name: ahavault_storage_data
  temp_data:
    name: ahavault_temp_data

networks:
  default:
    name: ahavault_network
