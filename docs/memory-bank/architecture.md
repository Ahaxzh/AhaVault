# ğŸ—ï¸ AhaVault æ¶æ„æ€»è§ˆ

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-04
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“ ç³»ç»Ÿæ¶æ„å›¾

```
                            Internet
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Nginx (Web)        â”‚
                    â”‚  - é™æ€æ–‡ä»¶æ‰˜ç®¡       â”‚
                    â”‚  - åå‘ä»£ç† /api/*   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Go Server          â”‚
                    â”‚  - Gin Framework     â”‚
                    â”‚  - ä¸šåŠ¡é€»è¾‘          â”‚
                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  PostgreSQL    â”‚   â”‚   Redis     â”‚
            â”‚  - å…ƒæ•°æ®      â”‚   â”‚  - ç¼“å­˜     â”‚
            â”‚  - å¼•ç”¨è®¡æ•°    â”‚   â”‚  - é™æµ     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Local Storage / S3    â”‚
            â”‚  - CAS æ–‡ä»¶å­˜å‚¨        â”‚
            â”‚  - AES-256 åŠ å¯†        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å®‰å…¨æ¶æ„

### ä¿¡å°åŠ å¯† (Envelope Encryption)

```
ä¸Šä¼ æ–‡ä»¶
    â†“
ç”Ÿæˆéšæœº DEK (256-bit)
    â†“
AES-256-GCM åŠ å¯†æ–‡ä»¶ â†’ å­˜å‚¨åˆ° CAS (SHA-256 å“ˆå¸Œè·¯å¾„)
    â†“
KEK åŠ å¯† DEK â†’ å­˜å‚¨ encrypted_dek åˆ°æ•°æ®åº“
```

**è¯¦ç»†è®¾è®¡**: [encryption.md](./encryption.md)

---

## ğŸ“¦ CAS å­˜å‚¨æ¶æ„

### å†…å®¹å¯»å€å­˜å‚¨

```
æ–‡ä»¶ â†’ SHA-256 å“ˆå¸Œ â†’ aa/bb/aabbccdd...
                          â†“
              file_blobs (ref_count)
                          â†“
         files_metadata (ç”¨æˆ·å¼•ç”¨)
```

**è¯¦ç»†è®¾è®¡**: [storage.md](./storage.md)

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨å…³ç³»

```
users (ç”¨æˆ·)
  â†“ 1:N
files_metadata (æ–‡ä»¶å…ƒæ•°æ®)
  â†“ N:1
file_blobs (ç‰©ç†å­˜å‚¨) [ref_count]
  â†“
CAS å­˜å‚¨ (ç£ç›˜æ–‡ä»¶)

share_sessions (åˆ†äº«ä¼šè¯)
  â†“ N:N
share_files (åˆ†äº«æ–‡ä»¶å…³è”)
  â†“
files_metadata
```

---

## ğŸš€ æ–‡ä»¶ä¸Šä¼ æµç¨‹

```
1. å‰ç«¯è®¡ç®— SHA-256 (Web Worker)
2. è°ƒç”¨ /api/files/check (ç§’ä¼ æ£€æµ‹)
   â”œâ”€ å­˜åœ¨ â†’ ç›´æ¥åˆ›å»º files_metadata + ref_count++
   â””â”€ ä¸å­˜åœ¨ â†’ ç»§ç»­ä¸‹ä¸€æ­¥
3. Tus åˆ†ç‰‡ä¸Šä¼ 
4. åç«¯åŠ å¯†æ–‡ä»¶ (DEK)
5. å­˜å‚¨åˆ° CAS (hash è·¯å¾„)
6. KEK åŠ å¯† DEK
7. åˆ›å»º file_blobs + files_metadata
```

---

## ğŸ“¤ æ–‡ä»¶åˆ†äº«æµç¨‹

```
1. ç”¨æˆ·åˆ›å»ºåˆ†äº« â†’ ç”Ÿæˆå–ä»¶ç 
2. æ¥æ”¶æ–¹è¾“å…¥å–ä»¶ç 
   â”œâ”€ éªŒè¯å¯†ç  (å¦‚æœ‰)
   â”œâ”€ æ£€æŸ¥è¿‡æœŸæ—¶é—´
   â””â”€ æ£€æŸ¥ä¸‹è½½æ¬¡æ•°
3. ä¸‹è½½æ–‡ä»¶
   â”œâ”€ è§£å¯† DEK (KEK)
   â”œâ”€ è¯»å–åŠ å¯†æ–‡ä»¶ (CAS)
   â”œâ”€ å®æ—¶è§£å¯† (DEK)
   â””â”€ æµå¼ä¼ è¾“ç»™å‰ç«¯
4. æ›´æ–° access_count
```

---

## ğŸ—‘ï¸ åƒåœ¾å›æ”¶æœºåˆ¶

```
å®šæ—¶ä»»åŠ¡ (æ¯å¤© 02:00)
    â†“
æŸ¥æ‰¾ ref_count = 0 çš„ file_blobs
    â†“
åˆ é™¤ CAS ç‰©ç†æ–‡ä»¶
    â†“
åˆ é™¤ file_blobs è®°å½•
```

**è¯¦ç»†è®¾è®¡**: [../tasks/backend/06-background.md](../tasks/backend/06-background.md)

---

## ğŸ“š è¯¦ç»†è®¾è®¡æ–‡æ¡£

- **ä¿¡å°åŠ å¯†**: [encryption.md](./encryption.md)
- **CAS å­˜å‚¨**: [storage.md](./storage.md)
- **å®‰å…¨ç­–ç•¥**: [security.md](./security.md)

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **æŠ€æœ¯æ ˆ**: [../memory-bank/tech-stack.md](../memory-bank/tech-stack.md)
- **API æ–‡æ¡£**: [../api/API.md](../api/API.md)
- **å¼€å‘æŒ‡å—**: [../guides/development.md](../guides/development.md)

---

**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
**æœ€åå®¡æ ¸**: 2026-02-04
