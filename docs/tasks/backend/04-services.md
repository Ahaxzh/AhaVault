# 业务服务层 (Services) 任务清单

**模块名称**: 业务服务层
**负责人**: Claude AI
**最后更新**: 2026-02-04
**当前进度**: 70%
**状态**: 🟡 进行中

---

## 📊 进度概览

| 服务 | 进度 | 测试覆盖率 | 状态 |
|------|------|-----------|------|
| PickupCode | 100% | 80%+ | ✅ |
| FileService | 100% | ~20% | ⚠️ |
| ShareService | 100% | ~20% | ⚠️ |
| UserService | 100% | ~20% | ⚠️ |
| AdminService | 0% | 0% | ⚪ |

---

## 📋 任务清单

### ✅ 已完成

- [x] `pickup_code.go` - 取件码生成服务
  - 完成时间: 2026-02-04
  - 测试文件: `pickup_code_test.go` ✅
  - 覆盖率: 80%+
  - 功能:
    - 生成 8 位字符取件码
    - 排除易混淆字符（O/I/0/1）
    - 碰撞检测

- [x] `file_service.go` - 文件管理服务
  - 完成时间: 2026-02-04
  - 测试文件: ❌ **缺失**
  - 覆盖率: ~20%
  - 功能:
    - 秒传检测（基于 SHA-256）
    - 配额检查
    - 引用计数管理
    - 文件列表查询
    - 文件删除（软删除）

- [x] `share_service.go` - 分享管理服务
  - 完成时间: 2026-02-04
  - 测试文件: ❌ **缺失**
  - 覆盖率: ~20%
  - 功能:
    - 创建分享链接
    - 验证取件码
    - 访问密码验证
    - 下载次数限制
    - 过期时间检查

- [x] `user_service.go` - 用户管理服务
  - 完成时间: 2026-02-04
  - 测试文件: ❌ **缺失**
  - 覆盖率: ~20%
  - 功能:
    - 用户注册
    - 用户登录
    - JWT 生成
    - 密码 bcrypt 加密

### 🔥 待办（高优先级 P0）

- [ ] `file_service_test.go` - 文件服务测试
  - 优先级: **P0** 🔥
  - 预计工作量: 4 小时
  - 目标覆盖率: 70%
  - 测试用例:
    - 秒传检测逻辑
    - 配额检查（超限场景）
    - 引用计数一致性
    - 软删除功能

- [ ] `share_service_test.go` - 分享服务测试
  - 优先级: **P0** 🔥
  - 预计工作量: 3 小时
  - 目标覆盖率: 70%
  - 测试用例:
    - 取件码验证
    - 密码验证
    - 下载次数限制
    - 过期时间检查

- [ ] `user_service_test.go` - 用户服务测试
  - 优先级: **P0** 🔥
  - 预计工作量: 3 小时
  - 目标覆盖率: 70%
  - 测试用例:
    - 注册流程（邮箱唯一性）
    - 登录流程（密码验证）
    - JWT 生成与验证

### ⚪ 待办（中优先级 P1）

- [ ] `admin_service.go` - 管理员服务
  - 优先级: P1
  - 预计工作量: 6 小时
  - 功能:
    - 用户管理（查询、禁用、配额调整）
    - 系统统计（用户数、文件数、存储使用）
    - 审计日志查询

- [ ] `admin_service_test.go` - 管理员服务测试
  - 优先级: P1
  - 依赖: admin_service.go 完成

---

## 🧪 测试状态

### 测试覆盖率

| 文件 | 测试文件 | 覆盖率 | 目标 | 状态 |
|------|---------|--------|------|------|
| `pickup_code.go` | `pickup_code_test.go` | 80%+ | 80% | ✅ |
| `file_service.go` | ❌ **缺失** | ~20% | 70% | ❌ |
| `share_service.go` | ❌ **缺失** | ~20% | 70% | ❌ |
| `user_service.go` | ❌ **缺失** | ~20% | 70% | ❌ |
| `admin_service.go` | - | 0% | 70% | ⚪ |

**总体覆盖率**: ~30% / 目标 70% ⚠️

### 待补充测试（详细清单）

#### file_service_test.go
- [ ] 测试秒传检测（文件已存在 vs 不存在）
- [ ] 测试配额检查（超限、正常）
- [ ] 测试引用计数（上传、删除、多用户引用）
- [ ] 测试软删除（deleted_at 标记）
- [ ] 测试文件列表分页

#### share_service_test.go
- [ ] 测试创建分享（单文件、多文件）
- [ ] 测试取件码唯一性
- [ ] 测试密码保护分享
- [ ] 测试下载次数限制（1 次、N 次、无限）
- [ ] 测试过期时间检查

#### user_service_test.go
- [ ] 测试用户注册（成功、邮箱重复）
- [ ] 测试用户登录（成功、密码错误、用户不存在）
- [ ] 测试 JWT 生成与解析
- [ ] 测试 bcrypt 密码加密

---

## 🐛 已知问题

### 高优先级 ⚠️

1. **测试覆盖率严重不足**
   - 影响范围: 整个 Services 层
   - 当前覆盖率: ~30%
   - 目标覆盖率: 70%
   - 解决方案: 立即补充测试（见上方待办）
   - 负责人: Claude AI
   - 预计修复: 2026-02-06

---

## 📝 技术债务

无技术债务 ✅

---

## 🔗 相关文档

- **数据模型**: [01-models.md](./01-models.md)
- **加密模块**: [02-crypto.md](./02-crypto.md)
- **存储引擎**: [03-storage.md](./03-storage.md)
- **测试任务**: [../testing/backend-tests.md](../testing/backend-tests.md)

---

## 📅 更新日志

### 2026-02-04
- ✅ 完成 pickup_code.go + 测试
- ✅ 完成 file_service.go（无测试）
- ✅ 完成 share_service.go（无测试）
- ✅ 完成 user_service.go（无测试）
- ⚠️ 识别测试覆盖率不足问题

---

**维护者**: Claude AI
**下一步**: 立即补充 Services 层测试（P0 任务）
